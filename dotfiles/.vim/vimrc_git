" require vim-fugitive

fu! ToggleGit()
  let bufname=bufname('fugitive:')
  let bufno = bufname->bufloaded()
  if bufno == 0
    exe 'vertical Git'
  else
    exe 'bd ' . bufname
  endif
endf
nmap <silent>  <C-g> :call ToggleGit()<CR>
nmap <Leader>gdf :Gvdiffsplit<SPACE>

fu! SearchInGit(text)
  exe 'Gclog -S' . a:text . ' -- %'
  call feedkeys("/".a:text."\r")
endf
nmap <silent> <Leader>gss :call SearchInGit(expand('<cword>'))<CR>

fu! GitDiffToolACommmit()
  let cc = getline(1, 1)
  let a = split(cc[0])
  let cc = a[1]
  let pc = getline(2, 2)
  let a = split(pc[0])
  let pc = a[1]
  silent exe 'bd'
  silent exe '!git diff --name-status ' . pc . " " . cc . '>.tmp.gitdiff'
  exe "tabnew"
  exe 'view .tmp.gitdiff'
  call SetGitToolDiffMenu2Branch(pc, cc)
endf
nmap <silent> <Leader>gdc :call GitDiffToolACommmit()<CR>

fu! GoToCommitAndFindThisChange()
  let lineno = line('.')
  let cwd = getcwd()
  let file = expand('%p')
  let file = substitute(file, cwd, "", "")
  let file = substitute(file, "^/", "", "")
  let file = escape(file, "/")
  call feedkeys(" gc " . ":sleep 500m\<CR>" . ":call GitDiffToolACommmit()\<CR>" . "/" . file . "\<CR>" . "\<CR>" . lineno ."\<CR>")
endfunction
nmap <silent> <Leader>gfc :call GoToCommitAndFindThisChange()<CR>

fu! GitToolDiffBranch(branch)
  let branch = a:branch
  if len(branch) == 0
    let branch = "HEAD"
  endif
  silent exe '!git diff --name-status "' . branch . '">/tmp/.tmp.gitdiff'
  exe "tabnew"
  exe 'view /tmp/.tmp.gitdiff'
  setlocal nomodifiable
  exe 'let b:bbranch="' . a:branch . '"'
  nmap <buffer> <silent> <leader>q :windo bd<CR>
  nmap <buffer> <silent> <CR> :call GitToolDiffFile2BranchInSameTab(getline('.'), b:bbranch, "")<CR>
  nmap <buffer> <silent> <LeftRelease> :call GitToolDiffFile2BranchInSameTab(getline('.'), b:bbranch, "")<CR>
  if getline('.') != ''
    call feedkeys("\<CR>")
  endif
endf
command! -bar -bang -nargs=* -complete=customlist,fugitive#CompleteObject GitToolDiffBranch call GitToolDiffBranch(<q-args>)
nmap <Leader>gtd :GitToolDiffBranch<SPACE>

" diff two random branchs
fu! SetGitToolDiffMenu2Branch(abranch, bbranch)
  setlocal nomodifiable
  exe 'let b:abranch="' . a:abranch . '"'
  exe 'let b:bbranch="' . a:bbranch . '"'
  nmap <buffer> <silent> <leader>q :windo bd<CR>
  nmap <buffer> <silent> <CR> :call GitToolDiffFile2BranchInSameTab(getline('.'), b:abranch, b:bbranch)<CR>
  nmap <buffer> <silent> <LeftRelease> :call GitToolDiffFile2BranchInSameTab(getline('.'), b:abranch, b:bbranch)<CR>
endf

fu! GitToolDiffFile2BranchInSameTab(change, abranch, bbranch)
  if winnr('$') > 1
    exe '2,3windo bd'
  endif
  let changes = split(a:change)
  let ct = changes[0]
  let ff = changes[1]
  " exe "belowright 80vsplit " . ff
  " exe "wincmd h | vertical resize 60 | setlocal winfixwidth | wincmd l"
  exe "belowright split " . ff
  exe "wincmd k | resize 10 | setlocal winfixwidth | wincmd j"
  exe "Gvdiffsplit " . a:abranch
  call SetupGitBufferMap()

  exe "wincmd l"
  if len(changes) == 3
    let ff = changes[2]
  endif
  exe "e " . ff
  if a:bbranch != ""
    exe "Gvdiffsplit " . a:bbranch
    exe "wincmd l | q"
  endif
  exe "2,3windo diffthis"
  call SetupGitBufferMap()
endf

fu! GitToolDiffFile2BranchUsingTab(change, abranch, bbranch)
  let changes = split(a:change)
  let ff = changes[1]
  exe "tabedit " . ff
  exe "Gvdiffsplit " . a:abranch
  call SetupGitBufferMap()

  exe "wincmd l"
  if len(changes) == 3
    let ff = changes[2]
  endif
  exe "e " . ff
  if a:bbranch != ""
    exe "Gvdiffsplit " . a:bbranch
    exe "wincmd l | q"
  endif
  exe "windo diffthis"
  call SetupGitBufferMap()
endf

fu! NextGTDFile()
  call feedkeys(" qj\<CR>")
endf
fu! PrevGTDFile()
  call feedkeys(" qk\<CR>")
endf
fu! SetupGitBufferMap()
  if winnr('$') > 2
    nmap <buffer> <silent> <leader>q :2,3windo bd<CR>
  else
    nmap <buffer> <silent> <leader>q :windo bd<CR>
  endif
  nmap <buffer> <silent> <CR> G
  nmap <buffer> <C-n> :call NextGTDFile()<CR>
  nmap <buffer> <C-p> :call PrevGTDFile()<CR>
endfunction
